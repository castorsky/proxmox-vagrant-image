---
# tasks file for pve-vagrant
- name: Revert old fashion names for network interfaces (ethXX)
  ansible.builtin.copy:
    src: "grub-network-interfaces.cfg"
    dest: "/etc/default/grub.d/network-interfaces.cfg"
    owner: root
    group: root
    mode: "0644"
    backup: false
  notify: Rebuild GRUB config

- name: Configure system network interfaces
  ansible.builtin.copy:
    src: "etc-network-interfaces"
    dest: "/etc/network/interfaces"
    owner: root
    group: root
    mode: "0644"
    backup: false

- name: Create vagrant user with predefined password
  ansible.builtin.user:
    name: "vagrant"
    create_home: true
    password: "$6$3rtaXePeRZrLePT/$NRkB3ZyNdwabzbQU2H3KqgahWPgZa5dwwsx8I22BfmIdgFYP.JaBli8PGSVaa1QoEHFOVoahfjEnPPYQryoEY/"

- name: Add insecure vagrant public key
  ansible.posix.authorized_key:
    user: vagrant
    key: "{{ pve_vagrant__vagrant_key_url }}"
    exclusive: true
    manage_dir: true
    state: present

- name: Setup sudoers for vagrant user
  ansible.builtin.copy:
    src: "vagrant-sudoers"
    dest: "/etc/sudoers.d/vagrant"
    owner: root
    group: root
    mode: "0640"
    backup: false

- name: Remove enterprise repositories
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
    update_cache: false
    state: absent
  loop:
    - deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise
    - deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise

- name: Add no-subscription repository
  ansible.builtin.apt_repository:
    repo: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    filename: "pve-no-subscription.list"
    update_cache: false
    state: present
